
networks:
  noscites-network:
    driver: bridge

volumes:
  # SHARD 1 (Données Paris)
  noscites_paris_1:
  noscites_lyon_1:
  
  # SHARD 2 (Données Lyon)
  noscites_lyon_2:
  noscites_paris_2:
  
  # Config Servers
  noscites_config_1:
  noscites_config_2:
  

services:
  # ============================================================================
  # CONFIG SERVERS (2 nodes)
  # ============================================================================

  noscites-config-1:
    image: mongo:latest
    container_name: noscites-config-1
    ports:
      - "27021:27017"
    volumes:
      - noscites_config_1:/data/db
    networks:
      - noscites-network
    command: mongod --configsvr --replSet configRS --port 27017 --bind_ip_all
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 15
      

  noscites-config-2:
    image: mongo:latest
    container_name: noscites-config-2
    ports:
      - "27022:27017"
    volumes:
      - noscites_config_2:/data/db
    networks:
      - noscites-network
    command: mongod --configsvr --replSet configRS --port 27017 --bind_ip_all
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 15
    depends_on:
      noscites-config-1:
        condition: service_started

  # ============================================================================
  # SERVICE D'INITIALISATION - CONTROLERS
  # ============================================================================

  noscites-init-configsvr:
    image: mongo:latest
    container_name: noscites-init-configsvr
    networks:
      - noscites-network
    depends_on:
      noscites-config-1:
        condition: service_healthy
      noscites-config-2:
        condition: service_healthy
    entrypoint: >
      sh -c '
      echo "=== Initializing MongoDB Sharded Cluster ===" &&
      export MONGO_CREDS="" &&
      echo "CREDS ; $${MONGO_CREDS}" &&
      sleep 10 &&
      echo "=== Step 1: Initializing Config Servers ReplicaSet ===" &&
      mongosh --host noscites-config-1 --port 27017 $${MONGO_CREDS} --eval "
        try {
          var status = rs.status();
          print(\"Config ReplicaSet already initialized.\");
        } catch (e) {
          print(\"Initializing Config ReplicaSet...\");
          rs.initiate({
            _id: \"configRS\",
            configsvr: true,
            members: [
              { _id: 0, host: \"noscites-config-1:27017\" },
              { _id: 1, host: \"noscites-config-2:27017\" }
            ]
          });
        }
      "'

  # ============================================================================
  # SHARD 1 (Données Paris - Primaire Paris, Secondaire Lyon)
  # ============================================================================

  noscites-shard1-paris:
    image: mongo:latest
    container_name: noscites-shard1-paris
    ports:
      - "27001:27017"
    volumes:
      - noscites_paris_1:/data/db

    networks:
      - noscites-network
    command: mongod --shardsvr --replSet shard1RS --port 27017 --bind_ip_all
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 25
      start_period: 45s
    depends_on:
      noscites-init-configsvr:
          condition: service_completed_successfully

  noscites-shard1-lyon:
    image: mongo:latest
    container_name: noscites-shard1-lyon
    ports:
      - "27002:27017"
    volumes:
      - noscites_lyon_1:/data/db
    networks:
      - noscites-network
    command: mongod --shardsvr --replSet shard1RS --port 27017 --bind_ip_all
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 25
      start_period: 45s
    depends_on:
      noscites-shard1-paris:
        condition: service_started

  noscites-shard1-arbiter:
    image: mongo:latest
    container_name: noscites-shard1-arbiter
    ports:
      - "27003:27017"
    networks:
      - noscites-network
    command: mongod --shardsvr --replSet shard1RS --port 27017 --bind_ip_all
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      noscites-shard1-lyon:
        condition: service_started

  # ============================================================================
  # SHARD 2 (Données Lyon - Primaire Lyon, Secondaire Paris)
  # ============================================================================

  noscites-shard2-lyon:
    image: mongo:latest
    container_name: noscites-shard2-lyon
    ports:
      - "27011:27017"
    volumes:
      - noscites_lyon_2:/data/db
    networks:
      - noscites-network
    command: mongod --shardsvr --replSet shard2RS --port 27017 --bind_ip_all
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 25
      start_period: 45s
    depends_on:
      noscites-init-configsvr:
          condition: service_completed_successfully

  noscites-shard2-paris:
    image: mongo:latest
    container_name: noscites-shard2-paris
    ports:
      - "27012:27017"
    volumes:
      - noscites_paris_2:/data/db
    networks:
      - noscites-network
    command: mongod --shardsvr --replSet shard2RS --port 27017 --bind_ip_all
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 25
      start_period: 45s
    depends_on:
      noscites-shard2-lyon:
        condition: service_started

  noscites-shard2-arbiter:
    image: mongo:latest
    container_name: noscites-shard2-arbiter
    ports:
      - "27013:27017"
    networks:
      - noscites-network
    command: mongod --shardsvr --replSet shard2RS --port 27017 --bind_ip_all
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      noscites-shard2-paris:
        condition: service_started
        
  # ============================================================================
  # SERVICE D'INITIALISATION - SHARDS REPLICA SETS
  # ============================================================================

  noscites-init-shards:
    image: mongo:latest
    container_name: noscites-init-shards
    networks:
      - noscites-network
    depends_on:
      noscites-shard1-arbiter:
        condition: service_healthy
      noscites-shard2-arbiter:
        condition: service_healthy
    entrypoint: >
        sh -c '
        sleep 60 &&
        echo "=== Step 2: Initializing Shard 1 ReplicaSet ===" &&
        mongosh --host noscites-shard1-paris:27017 --eval "
          rs.initiate({
            _id: \"shard1RS\",
            members: [
              { _id: 0, host: \"noscites-shard1-paris:27017\", priority: 10 },
              { _id: 1, host: \"noscites-shard1-lyon:27017\", priority: 5 },
              { _id: 2, host: \"noscites-shard1-arbiter:27017\", arbiterOnly: true }
            ]
          });
        " &&
        sleep 10 &&
        echo "=== Step 3: Initializing Shard 2 ReplicaSet ===" &&
        mongosh --host noscites-shard2-lyon:27017 --eval "
          rs.initiate({
            _id: \"shard2RS\",
            members: [
              { _id: 0, host: \"noscites-shard2-lyon:27017\", priority: 10 },
              { _id: 1, host: \"noscites-shard2-paris:27017\", priority: 5 },
              { _id: 2, host: \"noscites-shard2-arbiter:27017\", arbiterOnly: true }
            ]
          });
        " &&
        exit 0;
        '
  # ============================================================================
  # MONGOS ROUTER
  # ============================================================================

  noscites-router:
    image: mongo:latest
    container_name: noscites-router
    ports:
      - "27020:27017"
    networks:
      - noscites-network
    command: mongos --configdb configRS/noscites-config-1:27017,noscites-config-2:27017 --bind_ip_all
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      noscites-init-configsvr:
        condition: service_completed_successfully
      noscites-init-shards:
        condition: service_completed_successfully

  # ============================================================================
  # SERVICE D'INITIALISATION - CLUSTER
  # ============================================================================

  noscites-init-router:
    image: mongo:latest
    container_name: noscites-init-router
    networks:
      - noscites-network
    volumes:
      - ./scripts/init-cluster.js:/scripts/init-cluster.js
    depends_on:
      noscites-router:
        condition: service_healthy
    entrypoint: >
      sh -c '
      sleep 240 &&
      
      echo "" &&
      echo "=== Step 4: Adding Shards to Cluster ===" &&
      mongosh --host noscites-router:27017 /scripts/init-cluster.js &&
      
      echo "" &&
      echo "=== Cluster Initialization Complete ===" &&
      echo "Connect via: mongodb://localhost:27020" &&
      exit 0;
      '
